// Generated by CoffeeScript 1.9.1
var decoder, pow2, writeFloat;

decoder = new require('text-encoding').TextDecoder('utf-8');

pow2 = function(n) {
  if (n >= 0 && n < 31) {
    return 1 << n;
  } else {
    return pow2[n] || (pow2[n] = Math.pow(2, n));
  }
};

writeFloat = function(value, mantSize, expSize) {
  var b, eMax, eMin, exponent, mantissa, signBit;
  signBit = value < 0 ? 1 : 0;
  exponent = void 0;
  mantissa = void 0;
  eMax = ~(-1 << expSize - 1);
  eMin = 1 - eMax;
  if (value < 0) {
    value = -value;
  }
  if (value === 0) {
    exponent = 0;
    mantissa = 0;
  } else if (isNaN(value)) {
    exponent = 2 * eMax + 1;
    mantissa = 1;
  } else if (value === Infinity) {
    exponent = 2 * eMax + 1;
    mantissa = 0;
  } else {
    exponent = Math.floor(Math.log(value) / Math.LN2);
    if (exponent >= eMin && exponent <= eMax) {
      mantissa = Math.floor((value * pow2(-exponent) - 1) * pow2(mantSize));
      exponent += eMax;
    } else {
      mantissa = Math.floor(value / pow2(eMin - mantSize));
      exponent = 0;
    }
  }
  b = [];
  while (mantSize >= 8) {
    b.push(mantissa % 256);
    mantissa = Math.floor(mantissa / 256);
    mantSize -= 8;
  }
  exponent = exponent << mantSize | mantissa;
  expSize += mantSize;
  while (expSize >= 8) {
    b.push(exponent & 0xff);
    exponent >>>= 8;
    expSize -= 8;
  }
  b.push(signBit << expSize | exponent);
  return b;
};

module.exports = {
  readByte: function(b, i) {
    if (i == null) {
      i = 0;
    }
    return b[i];
  },
  readChar: function(b, i) {
    if (i == null) {
      i = 0;
    }
    return String.fromCharCode(b[i]);
  },
  readShort: function(b, i) {
    if (i == null) {
      i = 0;
    }
    return b[i] << 8 | b[i + 1];
  },
  readInt: function(b, i) {
    if (i == null) {
      i = 0;
    }
    return b[i] << 24 | b[i + 1] << 16 | b[i + 2] << 8 | b[i + 3];
  },
  readFloat: function(b, i) {
    var exponent, mantissa, sign;
    if (i == null) {
      i = 0;
    }
    sign = 1 - 2 * (b[i] >> 7);
    exponent = (b[i] << 1 & 0xff | b[i + 1] >> 7) - 127;
    mantissa = (b[i + 1] & 0x7f) << 16 | b[i + 2] << 8 | b[i + 3];
    if (exponent === 128) {
      if (mantissa !== 0) {
        return NaN;
      } else {
        return sign * Infinity;
      }
    }
    if (exponent === -127) {
      return sign * mantissa * pow2(-126 - 23);
    }
    return sign * (1 + mantissa * pow2(-23)) * pow2(exponent);
  },
  readDouble: function(b, i) {
    var exponent, mantissa, sign;
    if (i == null) {
      i = 0;
    }
    sign = 1 - 2 * (b[i] >> 7);
    exponent = ((b[i] << 1 & 0xff) << 3 | b[i + 1] >> 4) - ((1 << 10) - 1);
    mantissa = (b[i + 1] & 0x0f) * pow2(48) + b[i + 2] * pow2(40) + b[i + 3] * pow2(32) + b[i + 4] * pow2(24) + b[i + 5] * pow2(16) + b[i + 6] * pow2(8) + b[i + 7];
    if (exponent === 1024) {
      if (mantissa !== 0) {
        return NaN;
      } else {
        return sign * Infinity;
      }
    }
    if (exponent === -1023) {
      return sign * mantissa * pow2(-1022 - 52);
    }
    return sign * (1 + mantissa * pow2(-52)) * pow2(exponent);
  },
  readString: function(b) {
    return decoder.decode(b);
  },
  writeFloat: function(value) {
    return writeFloat(value, 23, 8);
  },
  writeDouble: function(value) {
    return writeFloat(value, 52, 11);
  }
};
